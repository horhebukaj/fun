ids_to_extract = ["https://gcc.luluhypermarket.com/en-ae/grocery-food-cupboard-breakfast-spreads-oats-bars/",
    "https://gcc.luluhypermarket.com/en-ae/grocery-food-cupboard-breakfast-spreads-cereals/",
    "https://gcc.luluhypermarket.com/en-ae/grocery-food-cupboard-breakfast-spreads-jams-spreads/",
    "https://gcc.luluhypermarket.com/en-ae/grocery-food-cupboard-breakfast-spreads-honey/",
    "https://gcc.luluhypermarket.com/en-ae/grocery-food-cupboard-canned-foods-canned-vegetables/",
    "https://gcc.luluhypermarket.com/en-ae/grocery-food-cupboard-canned-foods-canned-beans/",
    "https://gcc.luluhypermarket.com/en-ae/grocery-food-cupboard-canned-foods-canned-meat/",
    "https://gcc.luluhypermarket.com/en-ae/grocery-food-cupboard-canned-foods-canned-fish/",
    "https://gcc.luluhypermarket.com/en-ae/grocery-food-cupboard-rice-pasta-noodles-rice/",
    "https://gcc.luluhypermarket.com/en-ae/grocery-food-cupboard-rice-pasta-noodles-pasta-noodles/",
    "https://gcc.luluhypermarket.com/en-ae/grocery-food-cupboard-rice-pasta-noodles-soups/",
    "https://gcc.luluhypermarket.com/en-ae/grocery-food-cupboard-beverage-water/",
    "https://gcc.luluhypermarket.com/en-ae/grocery-food-cupboard-beverage-tea/",
    "https://gcc.luluhypermarket.com/en-ae/grocery-food-cupboard-beverage-coffee/",
    "https://gcc.luluhypermarket.com/en-ae/grocery-food-cupboard-beverage-softdrinks-juices/",
    "https://gcc.luluhypermarket.com/en-ae/grocery-food-cupboard-home-baking-sweeteners-home-baking/",
    "https://gcc.luluhypermarket.com/en-ae/grocery-food-cupboard-home-baking-sweeteners-sugar-other-sweeteners/",
    "https://gcc.luluhypermarket.com/en-ae/grocery-food-cupboard-biscuits-confectionery-biscuits/",
    "https://gcc.luluhypermarket.com/en-ae/grocery-food-cupboard-biscuits-confectionery-chocolates/",
    "https://gcc.luluhypermarket.com/en-ae/grocery-food-cupboard-biscuits-confectionery-candy/",
    "https://gcc.luluhypermarket.com/en-ae/grocery-food-cupboard-biscuits-confectionery-gums-mints/",
    "https://gcc.luluhypermarket.com/en-ae/grocery-food-cupboard-world-foods-arabic-food/",
    "https://gcc.luluhypermarket.com/en-ae/grocery-food-cupboard-world-foods-filipino-food/",
    "https://gcc.luluhypermarket.com/en-ae/grocery-food-cupboard-world-foods-indian-food/",
    "https://gcc.luluhypermarket.com/en-ae/grocery-food-cupboard-world-foods-korean-food/",
    "https://gcc.luluhypermarket.com/en-ae/grocery-food-cupboard-dressings-table-sauces-sides-salad-dressing-table-sauces/",
    "https://gcc.luluhypermarket.com/en-ae/grocery-food-cupboard-dressings-table-sauces-sides-bottled-olives-pickles/",
    "https://gcc.luluhypermarket.com/en-ae/grocery-food-cupboard-chips-snacks-chips/",
    "https://gcc.luluhypermarket.com/en-ae/grocery-food-cupboard-chips-snacks-snacks/",
    "https://gcc.luluhypermarket.com/en-ae/grocery-food-cupboard-chips-snacks-popcorn/",
    "https://gcc.luluhypermarket.com/en-ae/grocery-food-cupboard-chips-snacks-nuts-dates/",
    "https://gcc.luluhypermarket.com/en-ae/grocery-food-cupboard-frozen-food-ice-cream/",
    "https://gcc.luluhypermarket.com/en-ae/grocery-food-cupboard-frozen-food-ready-meals-snacks/",
    "https://gcc.luluhypermarket.com/en-ae/grocery-food-cupboard-frozen-food-burgers/",
    "https://gcc.luluhypermarket.com/en-ae/grocery-food-cupboard-frozen-food-pastry-sheets-dough/",
    "https://gcc.luluhypermarket.com/en-ae/grocery-food-cupboard-cooking-ingredients-cooking-sauces-cream/",
    "https://gcc.luluhypermarket.com/en-ae/grocery-food-cupboard-cooking-ingredients-oils-ghee/",
    "https://gcc.luluhypermarket.com/en-ae/grocery-food-cupboard-cooking-ingredients-salt-pepper/",
    "https://gcc.luluhypermarket.com/en-ae/grocery-food-cupboard-cooking-ingredients-pulses/",
    "https://gcc.luluhypermarket.com/en-ae/grocery-speciality-food-speciality-food-organic/",
    "https://gcc.luluhypermarket.com/en-ae/grocery-speciality-food-speciality-food-gluten-free/",
    "https://gcc.luluhypermarket.com/en-ae/grocery-speciality-food-speciality-food-sugar-free/",
    "https://gcc.luluhypermarket.com/en-ae/grocery-speciality-food-speciality-food-vegan/",
    "https://gcc.luluhypermarket.com/en-ae/fresh-food-dairy-eggs-cheese-fresh-milk/",
    "https://gcc.luluhypermarket.com/en-ae/grocery-food-cupboard-beverage-long-life-milk/",
    "https://gcc.luluhypermarket.com/en-ae/fresh-food-dairy-eggs-cheese-laban-flavoured-milk/",
    "https://gcc.luluhypermarket.com/en-ae/grocery-food-cupboard-beverage-dairy-alternatives/",
    "https://gcc.luluhypermarket.com/en-ae/fresh-food-dairy-eggs-cheese-yoghurt-chilled-desserts/",
    "https://gcc.luluhypermarket.com/en-ae/fresh-food-dairy-eggs-cheese-fresh-cream/",
    "https://gcc.luluhypermarket.com/en-ae/fresh-food-dairy-eggs-cheese-cheese/",
    "https://gcc.luluhypermarket.com/en-ae/fresh-food-dairy-eggs-cheese-butter-margarine/",
    "https://gcc.luluhypermarket.com/en-ae/fresh-food-dairy-eggs-cheese-eggs/",
    "https://gcc.luluhypermarket.com/en-ae/fresh-food-bakery-bread-basket/",
    "https://gcc.luluhypermarket.com/en-ae/fresh-food-bakery-cake-house/",
    "https://gcc.luluhypermarket.com/en-ae/fresh-food-bakery-arabic-bakery/"]
block_2= ["https://gcc.luluhypermarket.com/en-ae/fresh-food-bakery-asian-bakery/","https://gcc.luluhypermarket.com/en-ae/fresh-food-bakery-croissant-and-savories-corner/",
    "https://gcc.luluhypermarket.com/en-ae/fresh-food-bakery-healthy-bake-shop/",
    "https://gcc.luluhypermarket.com/en-ae/fresh-food-delicatessen-cold-cuts-prepacked-cooked-meats/",
    "https://gcc.luluhypermarket.com/en-ae/fresh-food-delicatessen-olives-pickles/",
    "https://gcc.luluhypermarket.com/en-ae/fresh-food-delicatessen-indian-ready-mix/",
    "https://gcc.luluhypermarket.com/en-ae/fresh-food-delicatessen-oriental-food/",
    "https://gcc.luluhypermarket.com/en-ae/fresh-food-delicatessen-hummus-labneh-other-prepacked-deli/",
    "https://gcc.luluhypermarket.com/en-ae/fresh-food-fruits-vegetables-fruits/",
    "https://gcc.luluhypermarket.com/en-ae/fresh-food-fruits-vegetables-vegetables/",
    "https://gcc.luluhypermarket.com/en-ae/fresh-food-fruits-vegetables-salad-vegetables/",
    "https://gcc.luluhypermarket.com/en-ae/fresh-food-fruits-vegetables-fruit-cuts/",
    "https://gcc.luluhypermarket.com/en-ae/fresh-food-fresh-meat-poultry-fresh-beef-veal/",
    "https://gcc.luluhypermarket.com/en-ae/fresh-food-fresh-meat-poultry-fresh-lamb/",
    "https://gcc.luluhypermarket.com/en-ae/fresh-food-fresh-meat-poultry-fresh-chicken/",
    "https://gcc.luluhypermarket.com/en-ae/fresh-food-fresh-meat-poultry-other-fresh-meat/",
    "https://gcc.luluhypermarket.com/en-ae/fresh-food-fresh-fish-seafoods-fresh-fish/",
    "https://gcc.luluhypermarket.com/en-ae/fresh-food-fresh-fish-seafoods-shellfish-speciality-seafoods/",
    "https://gcc.luluhypermarket.com/en-ae/fresh-food-fresh-fish-seafoods-smoked-fish-dried-fish/",
    "https://gcc.luluhypermarket.com/en-ae/fresh-food-on-the-go-meals-desserts-sweets-chilled-meals/",
    "https://gcc.luluhypermarket.com/en-ae/fresh-food-fresh-juice-salads-salads-pizzas/",
    "https://gcc.luluhypermarket.com/en-ae/fresh-food-fresh-juice-salads-sandwiches-burgers/",
    "https://gcc.luluhypermarket.com/en-ae/fresh-food-fresh-juice-salads-fresh-juice/",
    "https://gcc.luluhypermarket.com/en-ae/Pantry-Essentials/c/CPUAE0182",
    "https://gcc.luluhypermarket.com/en-ae/Frozen-Foods/c/CPUAE0180"]
ids_to_extract = ids_to_extract + block_2

import time
import random
import pandas as pd
from datetime import date

from selenium import webdriver
from selenium.webdriver.common.by import By
from selenium.webdriver.chrome.options import Options
from selenium.webdriver.chrome.service import Service
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from selenium.common.exceptions import (
    StaleElementReferenceException,
    TimeoutException,
    NoSuchElementException
)
from selenium_stealth import stealth

# Setup Chrome options for headless operation in Google Colab
chrome_options = Options()
chrome_options.add_argument("--headless")  # Run Chrome in headless mode
chrome_options.add_argument("--no-sandbox")
chrome_options.add_argument("--disable-dev-shm-usage")
chrome_options.add_argument("start-maximized")
chrome_options.add_argument("--disable-extensions")
chrome_options.add_experimental_option("excludeSwitches", ["enable-automation"])
chrome_options.add_experimental_option('useAutomationExtension', False)

# Path to chromedriver installed in Colab
service = Service('/usr/bin/chromedriver')

# Create the WebDriver instance
driver = webdriver.Chrome(service=service, options=chrome_options)

# Apply stealth techniques to bypass bot detection
stealth(driver,
        languages=["en-US", "en"],
        vendor="Google Inc.",
        platform="Win32",
        webgl_vendor="Intel Inc.",
        renderer="Intel Iris OpenGL Engine",
        fix_hairline=True)

# The URL you want to scrape
url = "https://www.luluhypermarket.com/en-ae"
driver.get(url)
driver.maximize_window()
driver.get(url)

# Global lists for storing scraped data
product_names = []
prices = []
categories = []

def get_text_safe(element, retries=3):
    """Attempt to extract text from an element with retries."""
    for _ in range(retries):
        try:
            text = element.text.strip()
            if text:
                return text
        except StaleElementReferenceException:
            time.sleep(0.5)  # Brief pause before retrying
    return ""

def loading_data():
    # Short random sleep to mimic human behavior and allow page updates
    time.sleep(random.randint(1, 3))
    driver.implicitly_wait(5)
    wait = WebDriverWait(driver, 30)

    # Wait for key product and price elements to appear
    try:
      wait.until(EC.presence_of_element_located((
          By.XPATH, '//a[contains(@class, "h-12") and contains(@class, "text-black") and contains(@class, "line-clamp-2")]'
      )))
      wait.until(EC.presence_of_element_located((
          By.XPATH, '//span[contains(@class, "text-base") and contains(@class, "leading-[1.5]") and contains(@class, "-tracking-[0.48px]")]'
      )))
      wait.until(EC.presence_of_element_located((
          By.XPATH, '//a[contains(@class, "h-12") and contains(@class, "text-black") and contains(@class, "line-clamp-2")]'
      )))
    except:
      driver.refresh()
      time.sleep(10)
      wait.until(EC.presence_of_element_located((
          By.XPATH, '//a[contains(@class, "h-12") and contains(@class, "text-black") and contains(@class, "line-clamp-2")]'
      )))
      wait.until(EC.presence_of_element_located((
          By.XPATH, '//span[contains(@class, "text-base") and contains(@class, "leading-[1.5]") and contains(@class, "-tracking-[0.48px]")]'
      )))
    # Retrieve the category text freshly using an appropriate selector
    try:
        category = driver.find_element(By.CSS_SELECTOR, ".text-lg.font-bold.text-black").text.strip()
    except Exception:
        category = "unknown"
    print(category)

    # Immediately extract text values from product and price elements
    product_elements = driver.find_elements(By.XPATH,
        '//a[contains(@class, "h-12") and contains(@class, "text-black") and contains(@class, "mb-2")]'
    )
    price_elements = driver.find_elements(By.XPATH,
        '//span[contains(@class, "text-base") and contains(@class, "leading-[1.5]") and contains(@class, "-tracking-[0.48px]")]'
    )

    product_texts = []
    for product in product_elements:
        text = get_text_safe(product)
        if text:
            product_texts.append(text)
            print(product.text)

    price_texts = []
    for price in price_elements:
        text = get_text_safe(price)
        if text:
            price_texts.append(text)

    # Append the extracted texts to the global lists
    for text in product_texts:
        product_names.append(text)
        categories.append(category)
    for text in price_texts:
        prices.append(text)

def getting_data(url):
    wait = WebDriverWait(driver, 30)
    # Load the URL and wait for the page to settle
    driver.get(url)
    driver.maximize_window()
    driver.execute_script("return document.body.scrollHeight")
    loading_data()

    # Loop through pagination if the ">" button exists
    while True:
        tabs = driver.find_elements(By.XPATH,
            '//a[contains(@class, "cursor-pointer") and contains(@class, "px-2") and contains(@class, "text-xs")]'
        )
        if tabs and tabs[-1].text == ">":
            next_tab = [tab for tab in tabs][-1]
            # Store a reference to an element on the current page
            old_product = driver.find_element(
                By.XPATH, '//a[contains(@class, "h-12") and contains(@class, "text-black") and contains(@class, "mb-2")]'
            )
            # Wait until the pagination button is clickable, then click it
            wait.until(EC.element_to_be_clickable((
                By.XPATH, '//a[contains(@class, "cursor-pointer") and contains(@class, "text-xs")]'
            )))
            next_tab.click()
            # Wait until the stored element is detached from the DOM
            wait.until(EC.staleness_of(old_product))
            loading_data()
            time.sleep(2)
        else:
            break

for povezava in ids_to_extract:
    getting_data(povezava)

driver.close()


print(product_names)
print(prices)
print(categories)
